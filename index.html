<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI-Democracy Signal Scanner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --S: #22c55e; --C: #ef4444; --W: #f59e0b; --N: #8b5cf6; --A: #6b7280;
    --bg: #0f172a; --surface: #1e293b; --border: #334155; --text: #e2e8f0; --muted: #94a3b8;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
  header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
  header h1 { font-size: 1.2rem; font-weight: 700; }
  header p { color: var(--muted); font-size: 0.8rem; margin-top: 0.2rem; }
  .badge { background: var(--surface); border: 1px solid var(--border); border-radius: 999px; padding: 0.25rem 0.75rem; font-size: 0.75rem; color: var(--muted); }
  .main { padding: 1.5rem 2rem; max-width: 1400px; margin: 0 auto; }

  /* STATS */
  .stats { display: grid; grid-template-columns: repeat(5,1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
  @media(max-width:700px){ .stats { grid-template-columns: repeat(2,1fr); } }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0.9rem; text-align: center; }
  .stat-n { font-size: 1.6rem; font-weight: 800; }
  .stat-label { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; line-height: 1.3; }

  /* FILTERS */
  .filters { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.25rem; align-items: center; }
  .filters label { color: var(--muted); font-size: 0.8rem; }
  select { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 0.4rem 0.75rem; font-size: 0.82rem; cursor: pointer; }

  /* TABS */
  .cat-tabs { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
  .tab { border: 1px solid var(--border); background: transparent; color: var(--muted); border-radius: 6px; padding: 0.35rem 0.85rem; font-size: 0.78rem; cursor: pointer; transition: all .15s; }
  .tab:hover { color: #fff; border-color: #475569; }
  .tab.active[data-cat="ALL"]          { background:#334155; border-color:#475569; color:#fff; }
  .tab.active[data-cat="STRENGTHENS"]  { background:var(--S); border-color:var(--S); color:#fff; }
  .tab.active[data-cat="COLLAPSE"]     { background:var(--C); border-color:var(--C); color:#fff; }
  .tab.active[data-cat="WEAKENS"]      { background:var(--W); border-color:var(--W); color:#fff; }
  .tab.active[data-cat="NEW_DEMOCRACY"]{ background:var(--N); border-color:var(--N); color:#fff; }
  .tab.active[data-cat="AMBIGUOUS"]    { background:var(--A); border-color:var(--A); color:#fff; }

  /* SIGNAL CARDS */
  .signal-list { display: flex; flex-direction: column; gap: 0.7rem; max-height: 560px; overflow-y: auto; }
  .signal { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; border-left: 3px solid var(--border); }
  .signal[data-primary="STRENGTHENS"]  { border-left-color: var(--S); }
  .signal[data-primary="COLLAPSE"]     { border-left-color: var(--C); }
  .signal[data-primary="WEAKENS"]      { border-left-color: var(--W); }
  .signal[data-primary="NEW_DEMOCRACY"]{ border-left-color: var(--N); }
  .signal[data-primary="AMBIGUOUS"]    { border-left-color: var(--A); }
  .signal-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.5rem; }
  .signal-title { font-size: 0.88rem; font-weight: 600; line-height: 1.35; }
  .signal-title a { color: var(--text); text-decoration: none; }
  .signal-title a:hover { text-decoration: underline; }
  .cats { display: flex; gap: 0.3rem; flex-wrap: wrap; flex-shrink: 0; }
  .cat-label { font-size: 0.68rem; font-weight: 700; padding: 0.18rem 0.5rem; border-radius: 4px; white-space: nowrap; }
  .cat-label.secondary { opacity: 0.7; font-weight: 500; }
  .STRENGTHENS   { background:#14532d; color:var(--S); }
  .COLLAPSE      { background:#7f1d1d; color:#fca5a5; }
  .WEAKENS       { background:#78350f; color:#fde68a; }
  .NEW_DEMOCRACY { background:#4c1d95; color:#c4b5fd; }
  .AMBIGUOUS     { background:#1f2937; color:var(--muted); }
  .signal-meta { display: flex; gap: 0.4rem; flex-wrap: wrap; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.4rem; }
  .pill { background:#1e293b; border:1px solid var(--border); border-radius:999px; padding:0.12rem 0.55rem; }
  .pill.strong { color:#fbbf24; border-color:#92400e; }
  .conf-bar { display:inline-block; width:36px; height:4px; background:var(--border); border-radius:2px; vertical-align:middle; margin-left:4px; position:relative; overflow:hidden; }
  .conf-fill { position:absolute; left:0; top:0; height:100%; border-radius:2px; }
  .signal-rationale { font-size: 0.79rem; color: var(--muted); line-height: 1.5; }
  .signal-secondary { font-size: 0.75rem; color: #64748b; margin-top: 0.3rem; font-style: italic; line-height: 1.4; }
  .finn-dot { display:inline-block; width:6px; height:6px; background:#38bdf8; border-radius:50%; margin-right:3px; }

  /* CHARTS */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
  @media(max-width:800px){ .grid { grid-template-columns: 1fr; } }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; }
  .card h2 { font-size: 0.82rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
  .chart-wrap { position: relative; height: 210px; }

  ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 999px; }
</style>
</head>
<body>
<header>
  <div>
    <h1>ðŸ”­ AI-Democracy Signal Scanner</h1>
    <p>Anticipatory signals â€” tekoÃ¤lyn vaikutus demokratiaan</p>
  </div>
  <span class="badge" id="last-updated">Loading...</span>
</header>

<div class="main">

  <div class="stats">
    <div class="stat"><div class="stat-n" style="color:var(--S)" id="n-s">0</div><div class="stat-label">Demokratia vahvistuu</div></div>
    <div class="stat"><div class="stat-n" style="color:var(--N)" id="n-n">0</div><div class="stat-label">Radikaalisti uusi demokratia</div></div>
    <div class="stat"><div class="stat-n" style="color:var(--W)" id="n-w">0</div><div class="stat-label">Demokratia heikentyy</div></div>
    <div class="stat"><div class="stat-n" style="color:var(--C)" id="n-c">0</div><div class="stat-label">Demokratia romahtaa</div></div>
    <div class="stat"><div class="stat-n" style="color:var(--A)" id="n-a">0</div><div class="stat-label">Monitulkintainen</div></div>
  </div>

  <div class="filters">
    <label>Domain:</label>
    <select id="domain-filter">
      <option value="ALL">Kaikki</option>
      <option value="epistemic">Episteeminen</option>
      <option value="procedural">Proseduraalinen</option>
      <option value="institutional">Institutionaalinen</option>
      <option value="participatory">Osallistuminen</option>
      <option value="power">Valta</option>
    </select>
    <label style="margin-left:0.5rem">Vahvuus:</label>
    <select id="strength-filter">
      <option value="ALL">Kaikki</option>
      <option value="strong">Vahva</option>
      <option value="moderate">Kohtalainen</option>
      <option value="weak">Heikko</option>
    </select>
    <label style="margin-left:0.75rem">
      <input type="checkbox" id="finn-only" style="margin-right:4px">
      <span class="finn-dot"></span>Suomi-relevanssi
    </label>
  </div>

  <div class="card" style="margin-bottom:1.5rem">
    <h2>Signaalivirta</h2>
    <div class="cat-tabs">
      <button class="tab active" data-cat="ALL">Kaikki</button>
      <button class="tab" data-cat="STRENGTHENS">Vahvistuu</button>
      <button class="tab" data-cat="NEW_DEMOCRACY">Uusi demokratia</button>
      <button class="tab" data-cat="WEAKENS">Heikentyy</button>
      <button class="tab" data-cat="COLLAPSE">Romahtaa</button>
      <button class="tab" data-cat="AMBIGUOUS">Monitulkintainen</button>
    </div>
    <div class="signal-list" id="signal-list"></div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Aikajana â€” signaalit viikottain</h2>
      <div class="chart-wrap"><canvas id="timeline-chart"></canvas></div>
    </div>
    <div class="card">
      <h2>Jakauma toimialueittain</h2>
      <div class="chart-wrap"><canvas id="domain-chart"></canvas></div>
    </div>
  </div>

</div>

<script>
const CAT_LABELS = { STRENGTHENS:"Vahvistuu", NEW_DEMOCRACY:"Uusi demokratia", WEAKENS:"Heikentyy", COLLAPSE:"Romahtaa", AMBIGUOUS:"Monitulkintainen" };
const CAT_COLORS = { STRENGTHENS:"#22c55e", NEW_DEMOCRACY:"#8b5cf6", WEAKENS:"#f59e0b", COLLAPSE:"#ef4444", AMBIGUOUS:"#6b7280" };
const label = c => CAT_LABELS[c] || c;
function allCats(s) { return [s.primary_category, ...(s.secondary_categories||[])]; }

let signals = [], activeTab = "ALL", tlChart, domChart;

async function loadSignals() {
  try { const r = await fetch("signals.json"); if (r.ok) signals = await r.json(); } catch(e) {}
  render();
}

function filtered() {
  const dom = document.getElementById("domain-filter").value;
  const str = document.getElementById("strength-filter").value;
  const fi  = document.getElementById("finn-only").checked;
  return signals.filter(s => {
    if (activeTab !== "ALL" && !allCats(s).includes(activeTab)) return false;
    if (dom !== "ALL" && s.domain !== dom) return false;
    if (str !== "ALL" && s.signal_strength !== str) return false;
    if (fi && !s.finnish_relevance) return false;
    return true;
  });
}

function renderSignals(data) {
  const el = document.getElementById("signal-list");
  if (!data.length) { el.innerHTML = '<p style="color:var(--muted);text-align:center;padding:2rem">Ei signaaleja valituilla suodattimilla.</p>'; return; }
  el.innerHTML = data.map(s => {
    const secCats = (s.secondary_categories||[]).filter(c => c !== s.primary_category);
    const confPct = Math.round((s.confidence||0)*100);
    return `
    <div class="signal" data-primary="${s.primary_category}">
      <div class="signal-header">
        <div class="signal-title"><a href="${s.url}" target="_blank">${s.title}</a></div>
        <div class="cats">
          <span class="cat-label ${s.primary_category}">${label(s.primary_category)}</span>
          ${secCats.map(c=>`<span class="cat-label secondary ${c}">${label(c)}</span>`).join('')}
        </div>
      </div>
      <div class="signal-meta">
        <span class="pill">${(s.source||'').replace(/_/g,' ')}</span>
        <span class="pill">${s.domain||''}</span>
        <span class="pill ${s.signal_strength==='strong'?'strong':''}">${s.signal_strength||''}</span>
        <span class="pill">${s.signal_type||''}</span>
        <span title="Confidence ${confPct}%">
          <span class="conf-bar"><span class="conf-fill" style="width:${confPct}%;background:${CAT_COLORS[s.primary_category]||'#475569'}"></span></span>
          <span style="font-size:0.7rem;color:#64748b">${confPct}%</span>
        </span>
        ${s.finnish_relevance?'<span class="pill" style="color:#38bdf8;border-color:#0c4a6e"><span class="finn-dot"></span>FI</span>':''}
        <span>${new Date(s.published||s.scanned_at).toLocaleDateString('fi-FI')}</span>
      </div>
      <div class="signal-rationale">${s.rationale||''}</div>
      ${s.secondary_rationale?`<div class="signal-secondary">â†³ ${s.secondary_rationale}</div>`:''}
    </div>`;
  }).join('');
}

function renderStats() {
  const count = cat => signals.filter(s => s.primary_category === cat).length;
  document.getElementById("n-s").textContent = count("STRENGTHENS");
  document.getElementById("n-n").textContent = count("NEW_DEMOCRACY");
  document.getElementById("n-w").textContent = count("WEAKENS");
  document.getElementById("n-c").textContent = count("COLLAPSE");
  document.getElementById("n-a").textContent = count("AMBIGUOUS");
  const dates = signals.map(s => s.scanned_at||s.published).sort();
  const last = dates[dates.length-1];
  document.getElementById("last-updated").textContent = last ? `Viimeksi skannattu: ${new Date(last).toLocaleDateString('fi-FI')}` : "Ei dataa";
}

function weekLabel(d) {
  const date = new Date(d);
  const w = Math.floor((date - new Date(date.getFullYear(),0,1))/604800000);
  return `V${w+1}/${date.getFullYear()}`;
}

function renderTimeline() {
  const weeks = {};
  const cats = ["STRENGTHENS","NEW_DEMOCRACY","WEAKENS","COLLAPSE"];
  signals.forEach(s => {
    const w = weekLabel(s.scanned_at||s.published);
    if (!weeks[w]) { weeks[w] = {}; cats.forEach(c => weeks[w][c]=0); }
    if (weeks[w][s.primary_category] !== undefined) weeks[w][s.primary_category]++;
  });
  const labels = Object.keys(weeks).sort();
  const mk = (cat, color, lbl) => ({ label:lbl, data:labels.map(l=>weeks[l][cat]||0), borderColor:color, backgroundColor:color+'33', fill:true, tension:0.3, pointRadius:3 });
  if (tlChart) tlChart.destroy();
  tlChart = new Chart(document.getElementById("timeline-chart"), {
    type:"line",
    data:{ labels, datasets:[mk("STRENGTHENS","#22c55e","Vahvistuu"), mk("NEW_DEMOCRACY","#8b5cf6","Uusi demokratia"), mk("WEAKENS","#f59e0b","Heikentyy"), mk("COLLAPSE","#ef4444","Romahtaa")] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#94a3b8",boxWidth:12}}}, scales:{x:{ticks:{color:"#64748b"}},y:{ticks:{color:"#64748b",stepSize:1},beginAtZero:true}} }
  });
}

function renderDomain() {
  const doms = {};
  signals.forEach(s => { doms[s.domain] = (doms[s.domain]||0)+1; });
  if (domChart) domChart.destroy();
  domChart = new Chart(document.getElementById("domain-chart"), {
    type:"doughnut",
    data:{ labels:Object.keys(doms), datasets:[{ data:Object.values(doms), backgroundColor:["#6366f1","#22c55e","#ef4444","#f59e0b","#8b5cf6","#06b6d4"], borderColor:"#1e293b", borderWidth:2 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#94a3b8",boxWidth:12}}} }
  });
}

function render() { renderSignals(filtered()); renderStats(); renderTimeline(); renderDomain(); }

document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => {
  document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
  t.classList.add("active"); activeTab = t.dataset.cat; render();
}));
["domain-filter","strength-filter","finn-only"].forEach(id => document.getElementById(id).addEventListener("change", render));

loadSignals();
</script>
</body>
</html>
